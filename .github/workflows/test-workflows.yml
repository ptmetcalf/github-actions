name: Test Reusable Workflows

on:
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - 'actions/**'
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  # Test 1: Validate YAML syntax of all workflows
  yaml-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate workflow YAML files
        run: |
          yamllint .github/workflows/*.yml

      - name: Validate action YAML files
        run: |
          yamllint actions/*/action.yml

  # Test 2: Test OpenTofu workflows with sample code
  test-tofu-workflows:
    runs-on: ubuntu-latest
    needs: yaml-validation
    strategy:
      matrix:
        test-case:
          - name: "simple-azure"
            description: "Basic Azure resources"
          - name: "azuread-resources"
            description: "Azure AD resources"
          - name: "multi-provider"
            description: "Multiple providers"
    steps:
      - uses: actions/checkout@v4

      - name: Create test infrastructure code
        run: |
          mkdir -p test-infra/stacks/test-${{ matrix.test-case.name }}
          cd test-infra/stacks/test-${{ matrix.test-case.name }}

          # Create versions.tf
          cat > versions.tf <<'EOF'
          terraform {
            required_version = ">= 1.6.0"

            # Use local backend for testing
            backend "local" {}

            required_providers {
              random = {
                source  = "hashicorp/random"
                version = "~> 3.0"
              }
            }
          }
          EOF

          # Create main.tf with test resources
          cat > main.tf <<'EOF'
          resource "random_string" "test" {
            length  = 8
            special = false
          }

          output "test_value" {
            value = random_string.test.result
          }
          EOF

          # Create tfvars
          mkdir -p ../../../env
          cat > ../../../env/test.tfvars <<'EOF'
          # Test variables
          EOF

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: latest

      - name: Test Init
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: tofu init -input=false

      - name: Test Format Check
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: tofu fmt -check -recursive

      - name: Test Validate
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: tofu validate

      - name: Test Plan
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: |
          tofu plan -input=false -no-color -var-file=../../../env/test.tfvars -out=tfplan | tee plan.txt

      - name: Verify plan artifact created
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: |
          if [ ! -f tfplan ]; then
            echo "❌ Plan artifact not created"
            exit 1
          fi
          echo "✅ Plan artifact created successfully"

      - name: Test Apply (local backend)
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: tofu apply -input=false -no-color tfplan

      - name: Verify outputs
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: |
          OUTPUT=$(tofu output -raw test_value)
          if [ -z "$OUTPUT" ]; then
            echo "❌ Output not generated"
            exit 1
          fi
          echo "✅ Output generated: $OUTPUT"

      - name: Test Destroy
        working-directory: test-infra/stacks/test-${{ matrix.test-case.name }}
        run: tofu destroy -auto-approve -var-file=../../../env/test.tfvars

  # Test 3: Test security scanning tools
  test-security-scanning:
    runs-on: ubuntu-latest
    needs: yaml-validation
    steps:
      - uses: actions/checkout@v4

      - name: Create test infrastructure
        run: |
          mkdir -p test-security/infra
          cd test-security/infra

          cat > main.tf <<'EOF'
          terraform {
            required_providers {
              azurerm = {
                source  = "hashicorp/azurerm"
                version = "~> 3.0"
              }
            }
          }

          provider "azurerm" {
            features {}
          }

          resource "azurerm_resource_group" "test" {
            name     = "rg-test"
            location = "eastus"
          }

          resource "azurerm_storage_account" "test" {
            name                     = "sttest12345"
            resource_group_name      = azurerm_resource_group.test.name
            location                 = azurerm_resource_group.test.location
            account_tier             = "Standard"
            account_replication_type = "LRS"

            # Intentional misconfig for testing
            min_tls_version = "TLS1_0"
          }
          EOF

      - name: Test tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: test-security/infra
          soft_fail: true

      - name: Test Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: test-security/infra
          framework: terraform
          soft_fail: true
          quiet: true

      - name: Verify security scans ran
        run: echo "✅ Security scanning tools tested successfully"

  # Test 4: Test Bicep workflows
  test-bicep-workflows:
    runs-on: ubuntu-latest
    needs: yaml-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Install Bicep
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep
          bicep --version

      - name: Create test Bicep template
        run: |
          mkdir -p test-bicep/infra
          cd test-bicep/infra

          cat > main.bicep <<'EOF'
          targetScope = 'resourceGroup'

          @description('Location for resources')
          param location string = resourceGroup().location

          @description('Environment name')
          param environment string = 'test'

          resource storageAccount 'Microsoft.Storage/storageAccounts@2023-01-01' = {
            name: 'sttest${uniqueString(resourceGroup().id)}'
            location: location
            sku: {
              name: 'Standard_LRS'
            }
            kind: 'StorageV2'
            tags: {
              environment: environment
            }
          }

          output storageAccountName string = storageAccount.name
          EOF

          cat > main.bicepparam <<'EOF'
          using 'main.bicep'

          param environment = 'test'
          EOF

      - name: Test Bicep build
        working-directory: test-bicep/infra
        run: bicep build main.bicep

      - name: Test Bicep lint
        working-directory: test-bicep/infra
        run: |
          az bicep lint --file main.bicep || echo "⚠️  Linting completed with warnings"

      - name: Verify Bicep ARM template generated
        working-directory: test-bicep/infra
        run: |
          if [ ! -f main.json ]; then
            echo "❌ ARM template not generated"
            exit 1
          fi
          echo "✅ ARM template generated successfully"

  # Test 5: Test composite actions
  test-composite-actions:
    runs-on: ubuntu-latest
    needs: yaml-validation
    steps:
      - uses: actions/checkout@v4

      - name: Test setup-tofu action
        uses: ./actions/setup-tofu
        with:
          tofu_version: latest

      - name: Verify OpenTofu installed
        run: |
          tofu version
          echo "✅ OpenTofu installed successfully"

      - name: Test setup-bicep action (if available)
        uses: ./actions/setup-bicep
        continue-on-error: true

  # Test 6: Test pre-commit workflow
  test-precommit:
    runs-on: ubuntu-latest
    needs: yaml-validation
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Create test pre-commit config
        run: |
          cat > .pre-commit-config.yaml <<'EOF'
          repos:
            - repo: https://github.com/pre-commit/pre-commit-hooks
              rev: v4.5.0
              hooks:
                - id: trailing-whitespace
                - id: end-of-file-fixer
                - id: check-yaml
                - id: check-added-large-files
          EOF

      - name: Test pre-commit run
        run: pre-commit run --all-files

  # Summary job
  test-summary:
    runs-on: ubuntu-latest
    needs:
      - yaml-validation
      - test-tofu-workflows
      - test-security-scanning
      - test-bicep-workflows
      - test-composite-actions
      - test-precommit
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Validation | ${{ needs.yaml-validation.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenTofu Workflows | ${{ needs.test-tofu-workflows.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scanning | ${{ needs.test-security-scanning.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bicep Workflows | ${{ needs.test-bicep-workflows.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Composite Actions | ${{ needs.test-composite-actions.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit | ${{ needs.test-precommit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any critical tests failed
          if [ "${{ needs.yaml-validation.result }}" != "success" ] || \
             [ "${{ needs.test-tofu-workflows.result }}" != "success" ] || \
             [ "${{ needs.test-composite-actions.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Critical tests failed. Please review and fix before merging.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All critical tests passed!**" >> $GITHUB_STEP_SUMMARY
